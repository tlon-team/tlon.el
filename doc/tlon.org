#+title: tlon
#+author: Pablo Stafforini
#+EXCLUDE_TAGS: noexport
#+language: en
#+options: ':t toc:nil author:t email:t num:t
#+startup: content
#+export_file_name: tlon.texi
#+texinfo_filename: tlon.info
#+texinfo_dir_category: Emacs misc features
#+texinfo_dir_title: Tlon Babel: (tlon)
#+texinfo_dir_desc: Companion Emacs package for Tlön
#+texinfo_header: @set MAINTAINERSITE @uref{https://github.com/tlon-team/tlon,maintainer webpage}
#+texinfo_header: @set MAINTAINER Pablo Stafforini
#+texinfo_header: @set MAINTAINEREMAIL @email{pablo@tlon.team}
#+texinfo_header: @set MAINTAINERCONTACT @uref{mailto:pablo@tlon.team,contact the maintainer}
#+texinfo: @insertcopying

~tlon~ provides all the Emacs functionality used by the Tlön team.

* AI Functionality (=tlon-ai.el=)
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai
:END:

This module provides integration with AI models for various tasks such as summarization, translation, image description, and code manipulation within the Tlön ecosystem. It leverages the =gptel= package and its extensions.

** User Options
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-options
:END:

This section describes the user-configurable options available in =tlon-ai.el=.

*** Batch Processing Function
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-batch-fun
:END:
#+vindex: tlon-ai-batch-fun
The user option ~tlon-ai-batch-fun~ specifies a function to be run when ~tlon~ operates in batch mode. This allows for automated processing of multiple items using AI functions. Set this to the symbol of the desired function.

#+begin_src emacs-lisp
(setq tlon-ai-batch-fun 'my-batch-processing-function)
#+end_src

*** Overwrite Image Alt Text
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-overwrite-alt-text
:END:
#+vindex: tlon-ai-overwrite-alt-text
The user option ~tlon-ai-overwrite-alt-text~ controls whether existing alt text in image tags should be overwritten when generating new descriptions.

- If non-nil, existing alt text will be replaced by the newly generated text when using ~tlon-ai-set-image-alt-text-in-buffer~.
- If nil (the default), existing alt text will be preserved.

Note: The command ~tlon-ai-set-image-alt-text~ (operating on a single image tag at point) *always* overwrites existing alt text, regardless of this option's setting.

*** Edit Prompt Before Sending
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-edit-prompt
:END:
#+vindex: tlon-ai-edit-prompt
When the user option ~tlon-ai-edit-prompt~ is non-nil, ~tlon~ will prompt the user to edit the generated prompt string before sending it to the AI model. This allows for on-the-fly customization of AI requests.

#+begin_src emacs-lisp
(setq tlon-ai-edit-prompt t)
#+end_src

*** Auto Proofread Reference Articles
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-auto-proofread
:END:
#+vindex: tlon-ai-auto-proofread
If the user option ~tlon-ai-auto-proofread~ is set to a non-nil value, ~tlon~ will automatically initiate the proofreading process using the configured AI model after a reference article has been generated via ~tlon-ai-create-reference-article~.

*** Custom Models
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-custom-models
:END:

~tlon~ allows specifying different AI models for specific tasks, overriding the default =gptel= model configuration. This enables using models optimized for particular capabilities (e.g., large context window for summarization, advanced reasoning for proofreading).

Each option takes a cons cell =(BACKEND . MODEL)=, where =BACKEND= is a string (e.g., ="ChatGPT"=, ="Gemini"=) and =MODEL= is a symbol representing the specific model (e.g., =gpt-4.5-preview=, =gemini-2.0-flash-thinking-exp-01-21=). Refer to ~gptel-extras-ai-models~ for available options. If an option is nil, the default =gptel= model is used for that task.

#+vindex: tlon-ai-summarization-model
+ ~tlon-ai-summarization-model~ :: Model for summarizing text (e.g., generating abstracts, synopses). It's recommended to use a model with a large context window.
  #+begin_src emacs-lisp
  (setq tlon-ai-summarization-model '("Gemini" . gemini-2.0-flash-thinking-exp-01-21))
  #+end_src

#+vindex: tlon-ai-markdown-fix-model
+ ~tlon-ai-markdown-fix-model~ :: Model for fixing Markdown formatting issues, especially when comparing original and translated documents.
  #+begin_src emacs-lisp
  (setq tlon-ai-markdown-fix-model '("Gemini" . gemini-2.0-flash-thinking-exp-01-21))
  #+end_src

#+vindex: tlon-ai-create-reference-article-model
+ ~tlon-ai-create-reference-article-model~ :: Model used by ~tlon-ai-create-reference-article~ to draft encyclopedia-style articles based on provided source materials.
  #+begin_src emacs-lisp
  (setq tlon-ai-create-reference-article-model nil) ; Use default gptel model
  #+end_src

#+vindex: tlon-ai-proofread-reference-article-model
+ ~tlon-ai-proofread-reference-article-model~ :: Model used by ~tlon-ai-proofread-reference-article~ for correcting factual errors, calculation mistakes, etc., in generated reference articles. Often benefits from a more powerful model.
  #+begin_src emacs-lisp
  (setq tlon-ai-proofread-reference-article-model '("ChatGPT" . gpt-4.5-preview))
  #+end_src

** Commands
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-commands
:END:

This section details the interactive commands provided by =tlon-ai.el=.

*** Translation Variants
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-translate
:END:
#+findex: tlon-ai-translate
The command ~tlon-ai-translate~ prompts for text and returns ten alternative Spanish translations using the configured AI model. The user can then select the preferred translation from the minibuffer, which is copied to the kill ring.

*** Writing Reference Articles
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-create-reference-article
:END:
#+findex: tlon-ai-create-reference-article
The command ~tlon-ai-create-reference-article~ generates a new encyclopedia-style article based on the current buffer's content and linked sources.

It extracts the title from the buffer's front matter (=title= key). It determines the language of the article from the current file. It constructs a prompt using ~tlon-ai-write-reference-article-prompt~, instructing the AI to synthesize information primarily from attached source files (added to the =gptel= context via ~tlon-add-add-sources-to-context~) and an optional glossary (added via ~tlon-add-glossary-to-context~).

The AI response (the generated article) is placed in a new buffer. If the user confirms, it can then be proofread using ~tlon-ai-proofread-reference-article~. The model used can be customized via ~tlon-ai-create-reference-article-model~.

*** Proofreading Reference Articles
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-proofread-reference-article
:END:
#+findex: tlon-ai-proofread-reference-article
The command ~tlon-ai-proofread-reference-article~ sends the content of the current buffer (assumed to be a reference article) to the AI for proofreading.

It uses the prompt defined in ~tlon-ai-proofread-reference-article-prompt~, instructing the AI to act as an expert proofreader, focusing on factual errors, calculation mistakes, and other important issues within the context of an encyclopedia of effective altruism. The language is determined from the current file.

The AI's response, containing the proofread version or comments, is displayed in a new buffer named "*Comments on [Article Title]*". The model used can be customized via ~tlon-ai-proofread-reference-article-model~.

*** Rewriting Text
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-rewrite
:END:
#+findex: tlon-ai-rewrite
The command ~tlon-ai-rewrite~ prompts for text (defaulting to the active region) and requests ten alternative Spanish rewrites from the AI using the prompt ~tlon-ai-rewrite-prompt~.

The user selects one of the suggested variants from the minibuffer. If a region was active, it is deleted and replaced with the selected variant. The selected variant is also copied to the kill ring.

*** Image Description
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-describe-image
:END:
#+findex: tlon-ai-describe-image
The command ~tlon-ai-describe-image~ generates a concise description (alt text) for an image file.

It prompts the user to select an image file if one isn't automatically detected (e.g., from a =Figure= tag at point or the file at point in Dired). It determines the desired language for the description based on the context (e.g., the language of the current buffer).

It uses the prompt from ~tlon-ai-describe-image-prompt~ for the determined language, instructing the AI to provide a one- or two-sentence description under 50 words. The image file is added to the =gptel= context for the request.

By default, the resulting description is displayed as a message. An optional CALLBACK argument can be provided programmatically to handle the response differently.

*** Setting Image Alt Text
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-set-image-alt-text
:END:
#+findex: tlon-ai-set-image-alt-text
The command ~tlon-ai-set-image-alt-text~ automatically generates and inserts an alt text description for an image tag (=Figure= or =OurWorldInData=) at point.

It extracts the image source (=src=) attribute from the tag, locates the corresponding image file (handling local paths and Our World In Data URLs), and then calls ~tlon-ai-describe-image~ to get the description. The generated alt text is then inserted into the =alt= attribute of the image tag at point. This command *always* overwrites any existing alt text.

#+findex: tlon-ai-set-image-alt-text-in-buffer
The command ~tlon-ai-set-image-alt-text-in-buffer~ iterates through all =Figure= and =OurWorldInData= tags in the current buffer and calls ~tlon-ai-set-image-alt-text~ for each one.

Whether it overwrites existing alt text depends on the value of the user option ~tlon-ai-overwrite-alt-text~.

*** Fixing Markdown Formatting
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-fix-markdown-format
:END:
#+findex: tlon-ai-fix-markdown-format
The command ~tlon-ai-fix-markdown-format~ attempts to restore lost or altered formatting in a translated Markdown file by comparing it paragraph by paragraph with its original counterpart.

It identifies the original file using ~tlon-get-counterpart~. It retrieves corresponding paragraphs from both files using ~tlon-get-corresponding-paragraphs~. For each pair of paragraphs, it sends a request to the AI using the prompt ~tlon-ai-fix-markdown-format-prompt~, asking it to apply the formatting from the original paragraph to the translated text.

The command processes paragraphs concurrently (up to a limit defined internally) and includes a retry mechanism with exponential backoff for failed requests. If a paragraph fails permanently after 3 retries, the process aborts.

Upon successful completion of all paragraphs, the reconstructed content is saved to a new file named =[original-filename]--fixed.md=. The user is then prompted to optionally start an =ediff= session between the original translation and the newly fixed file. The model used can be customized via ~tlon-ai-markdown-fix-model~.

*** Generating Abstracts and Synopses
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-get-abstracts
:END:

These commands generate summaries of documents using AI.

#+findex: tlon-get-abstract-with-or-without-ai
+ ~tlon-get-abstract-with-or-without-ai~ :: This command first attempts to extract an abstract using non-AI methods via ~tlon-fetch-and-set-abstract~. If that fails (e.g., no abstract found in metadata or the file), it falls back to generating one using AI via ~tlon-get-abstract-with-ai~.

#+findex: tlon-get-abstract-with-ai
+ ~tlon-get-abstract-with-ai~ :: Generates a standard abstract (typically 100-250 words) for the specified content (file, region, PDF/HTML associated with BibTeX entry, etc.). It first asks the AI to check if an abstract already exists in the text using the prompt ~tlon-ai-get-abstract-prompts~. If found, the AI returns it; otherwise, the AI generates a new abstract following the guidelines in ~tlon-ai-how-to-write-abstract-prompt~. The language is either detected automatically or selected by the user. The result is typically inserted into the =abstract= field of the corresponding BibTeX entry or copied to the kill ring. The model used can be customized via ~tlon-ai-summarization-model~.

#+findex: tlon-shorten-abstract-with-ai
+ ~tlon-shorten-abstract-with-ai~ :: Takes an existing abstract (typically from the =abstract= field of the BibTeX entry at point) and asks the AI to shorten it to meet the length requirements specified in ~tlon-tex-max-abstract-length~, using the prompt ~tlon-ai-shorten-abstract-prompts~. The shortened abstract replaces the original one in the BibTeX entry.

#+findex: tlon-get-synopsis-with-ai
+ ~tlon-get-synopsis-with-ai~ :: Generates a more detailed summary (synopsis, typically 1000-2000 words) of the specified content. It uses the prompt ~tlon-ai-get-synopsis-prompts~. The resulting synopsis is copied to the kill ring. The model used can be customized via ~tlon-ai-summarization-model~.

#+findex: tlon-get-abstract-with-ai-from-pdf
+ ~tlon-get-abstract-with-ai-from-pdf~ :: A convenience command that specifically targets the PDF file associated with the BibTeX entry at point and calls ~tlon-get-abstract-with-ai~ on it.

#+findex: tlon-get-abstract-with-ai-from-html
+ ~tlon-get-abstract-with-ai-from-html~ :: A convenience command that specifically targets the HTML file associated with the BibTeX entry at point and calls ~tlon-get-abstract-with-ai~ on it.

*** Setting Language in BibTeX Entries
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-set-language-bibtex
:END:
#+findex: tlon-ai-set-language-bibtex
The command ~tlon-ai-set-language-bibtex~ automatically detects and sets the =langid= field for the BibTeX entry at point.

It sends the BibTeX entry text to the AI using the prompt ~tlon-ai-detect-language-bibtex-prompt~.

- If the entry already has a =langid= field:
  - If the detected language matches the existing =langid=, no change is made (unless the existing =langid= needs validation/standardization).
  - If they conflict, the user is prompted to choose which language to use.
- If the entry has no =langid= field, the detected language is added.

The language code is validated and standardized using ~tlon~'s language functions before being set.

*** Phonetic Transcription
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-phonetically-transcribe
:END:
#+findex: tlon-ai-phonetically-transcribe
The command ~tlon-ai-phonetically-transcribe~ generates the International Phonetic Alphabet (IPA) transcription for a given text string.

It prompts for the text to transcribe (defaulting to the active region or word at point) and determines the language (from the file or user selection). It uses the prompt ~tlon-ai-transcribe-phonetically-prompt~ for the specified language. The resulting IPA transcription is copied to the kill ring.

#+findex: tlon-phonetically-transcribe-in-buffer
The command ~tlon-phonetically-transcribe-in-buffer~ iterates through each line in the current buffer, calls ~tlon-ai-phonetically-transcribe~ on the line's content, and inserts the resulting IPA transcription after the original line, separated by a comma.

*** Audio Transcription
:PROPERTIES:
:CUSTOM_ID: h:tlon-transcribe-audio
:END:
#+findex: tlon-transcribe-audio
The command ~tlon-transcribe-audio~ transcribes an audio file using OpenAI's Whisper API.

It prompts the user to select an audio file. It retrieves the OpenAI API key (prompting to set it if necessary via ~tlon-tts-openai-get-or-set-key~). It then makes an asynchronous request to the OpenAI API endpoint using =curl=, uploading the audio file.

A CALLBACK function must be provided programmatically to handle the result. The callback receives the transcript text on success, or nil on failure.

*** Mathematical Expression Handling
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-math
:END:

#+findex: tlon-ai-convert-math
+ ~tlon-ai-convert-math~ :: Converts a natural language mathematical expression into LaTeX format. It prompts for the expression (defaulting to the region or =Math= tag content) and language. It uses the prompt ~tlon-ai-convert-math-prompt~. If point is on a =Math= tag, the LaTeX result is inserted as the second value in the =alt= attribute (preserving the original expression as the first value). Otherwise, the result is copied to the kill ring and messaged.

#+findex: tlon-ai-translate-math
+ ~tlon-ai-translate-math~ :: Converts a LaTeX mathematical expression into a natural language description (alt text). It prompts for the expression (defaulting to the region or =Math= tag content) and language. It uses the prompt ~tlon-ai-translate-math-prompt~. If point is on a =Math= tag, the natural language result is inserted as the first value in the =alt= attribute (preserving the LaTeX expression as the second value). Otherwise, the result is copied to the kill ring and messaged.

*** Fixing Encoding Errors
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-fix-encoding
:END:
#+findex: tlon-ai-fix-encoding-in-string
The command ~tlon-ai-fix-encoding-in-string~ attempts to correct encoding errors within a given string.

It typically operates on a JSON value identified at point using helper functions. It determines the language associated with the JSON key. It sends the string to the AI using the prompt ~tlon-ai-fix-encoding-prompt~, asking it to correct encoding issues like =cuýn= or =pronosticaci¾3\263n=. The corrected string is then copied to the kill ring.

#+findex: tlon-ai-fix-encoding-in-buffer
The command ~tlon-ai-fix-encoding-in-buffer~ is a specialized command designed to process a large JSON buffer containing potentially many encoding errors, chunk by chunk. It saves the corrected chunks to separate files. (This seems highly specific to a particular data processing task).

#+findex: tlon-ai-join-files
The command ~tlon-ai-join-files~ concatenates the content of chunk files (e.g., =chunk0.json=, =chunk1.json=, ...) generated by ~tlon-ai-fix-encoding-in-buffer~ back into a single output file (e.g., =fixed.json=).

*** Propagating Changes Across Repositories
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-propagate-changes
:END:
#+findex: tlon-ai-propagate-changes
The command ~tlon-ai-propagate-changes~ attempts to automatically apply changes made in the latest commit of the current file to its corresponding files in other ~tlon~ content repositories (originals and translations).

1. It identifies the current file, its repository, language, and the latest commit affecting it using ~tlon~ and Git functions.
2. It retrieves the diff for the file from that commit using =git show=.
3. It identifies all other ~tlon~ content repositories (excluding the source repo).
4. For each target repository:
   - It determines the corresponding target file using metadata lookups (~tlon-ai--find-target-file~), handling different scenarios (original to translation, translation to original, translation to translation).
   - If a target file is found and exists, it constructs a prompt asking the AI to apply the *semantic equivalent* of the source diff to the target file's content (provided in the prompt).
   - It sends the request to the AI.
   - The callback function (~tlon-ai--propagate-changes-callback~) receives the AI's response (the modified target content).
   - If the AI response is valid, the callback overwrites the target file with the new content.
   - It then stages and commits the changes in the target repository using Git, with a commit message indicating the source commit and repository.

This command relies heavily on accurate metadata (=original_path=) and consistent file structures across repositories.

*** Transient Menu
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-menu
:END:
#+findex: tlon-ai-menu
The command ~tlon-ai-menu~ displays a =transient= menu interface, providing quick access to most of the AI-related commands and options described above. It allows toggling options like =tlon-ai-overwrite-alt-text= and =tlon-ai-edit-prompt=, selecting models for specific tasks, setting batch functions, and invoking the various AI operations (summarization, image description, translation, etc.).

** Internal Functions and Variables
:PROPERTIES:
:CUSTOM_ID: h:tlon-ai-internals
:END:

This section lists some non-interactive functions and variables used internally by =tlon-ai.el=. While not intended for direct user interaction, understanding them can be helpful for customization or debugging.

+ ~tlon-make-gptel-request~: Core function for sending requests to the AI model via =gptel=. Handles prompt formatting, model selection, context checks, and callbacks.
+ ~tlon-ai-maybe-edit-prompt~: Conditionally allows editing the prompt based on ~tlon-ai-edit-prompt~.
+ ~tlon-warn-if-gptel-context~: Checks if the =gptel= context is empty and warns the user if not.
+ Callback functions (e.g., ~tlon-ai-callback-return~, ~tlon-ai-callback-copy~, ~tlon-ai-callback-save~, ~tlon-ai-callback-insert~, ~tlon-ai-callback-fail~): Handle responses from AI requests in various ways (returning value, copying, saving, inserting, error handling).
+ ~tlon-ai-batch-continue~: Helper for batch processing, moves to the next item and calls the batch function.
+ ~tlon-get-string-dwim~: Retrieves text content from various sources (file, region, buffer, PDF/HTML associated with BibTeX entry) for AI processing.
+ ~tlon-get-file-as-string~: Reads the content of a file (handling PDF conversion) into a string.
+ Prompt constants (e.g., ~tlon-ai-detect-language-prompt~, ~tlon-ai-translate-prompt~, ~tlon-ai-write-reference-article-prompt~, etc.): Store the various prompt templates used for different AI tasks, often including language-specific versions.
+ Change propagation helpers (~tlon-ai--get-commit-diff~, ~tlon-ai--find-target-file~, ~tlon-ai--commit-in-repo~, ~tlon-ai--propagate-changes-callback~): Internal functions used by ~tlon-ai-propagate-changes~.
+ Transient infix definitions (e.g., ~tlon-ai-infix-toggle-overwrite-alt-text~, ~tlon-ai-batch-fun-infix~, model selection infixes): Define the interactive elements within the ~tlon-ai-menu~.

* Clock Functionality (=tlon-clock.el=)
:PROPERTIES:
:CUSTOM_ID: h:tlon-clock
:END:

This module provides functions for interacting with Org mode's clocking mechanism (=org-clock=), specifically tailored for the Tlön workflow. It allows retrieving information about the currently clocked task, such as associated files or issues, and performing actions based on that information.

** Commands
:PROPERTIES:
:CUSTOM_ID: h:tlon-clock-commands
:END:

This section details the interactive commands provided by =tlon-clock.el=.

*** Open Clocked Task's File
:PROPERTIES:
:CUSTOM_ID: h:tlon-open-clock-file
:END:
#+findex: tlon-open-clock-file
The command ~tlon-open-clock-file~ identifies the BibTeX key associated with the currently running Org clock task (using ~tlon-get-clock-key~) and opens the corresponding file (located via ~tlon-get-file-from-key~). This provides quick access to the primary document related to the clocked task.

*** Open Clocked Task's Issue
:PROPERTIES:
:CUSTOM_ID: h:tlon-open-clock-issue
:END:
#+findex: tlon-open-clock-issue
The command ~tlon-open-clock-issue~ finds an =orgit-forge= link within the currently clocked heading, extracts the issue identifier (GID), and opens the corresponding issue using =forge-visit-issue=. This requires the clocked heading to contain a link like =[[orgit-topic:ISSUE_GID][...]]= and for the =forge= package to be configured.

*** Copy Region or Buffer
:PROPERTIES:
:CUSTOM_ID: h:tlon-copy-dwim
:END:
#+findex: tlon-copy-dwim
The command ~tlon-copy-dwim~ ("Do What I Mean") copies text to the kill ring. If a region is active, it copies the region's content. If no region is active, it copies the entire content of the current buffer. This is a general utility command included in this module.

** Internal Functions and Variables
:PROPERTIES:
:CUSTOM_ID: h:tlon-clock-internals
:END:

This section lists non-interactive functions and variables used internally or potentially useful for advanced customization.

*** Getting Clock Information
:PROPERTIES:
:CUSTOM_ID: h:tlon-clock-getters
:END:

#+findex: tlon-get-clock
+ ~tlon-get-clock~ :: Returns the raw string of the currently clocked heading (=org-clock-current-task=). Errors if no clock is running.

#+findex: tlon-get-clock-key
+ ~tlon-get-clock-key~ :: Extracts the BibTeX key from the clocked heading string. It assumes the key is enclosed in backticks (e.g., ``key``) and uses the regular expression ~tlon-key-regexp~ to find it.

#+findex: tlon-get-clock-file
+ ~tlon-get-clock-file~ :: Retrieves the full file path associated with the BibTeX key found in the clocked heading. Uses ~tlon-get-clock-key~ and ~tlon-get-file-from-key~.

#+findex: tlon-get-clock-issue
+ ~tlon-get-clock-issue~ :: Finds the first =orgit-forge= link in the clocked heading (=org-clock-heading=) and returns the issue identifier (GID) part of the link (e.g., the part after =orgit-topic:=).

#+findex: tlon-get-clock-action
+ ~tlon-get-clock-action~ :: Extracts the assumed "action" from the clocked heading. It expects the action to be the second word in the heading string (after the first word, often a verb like "Translate"). It validates this word against the list of known actions defined in the Tlön labels configuration (~tlon-label-lookup-all :action~).

#+findex: tlon-get-clock-label
+ ~tlon-get-clock-label~ :: Retrieves the label associated with the action identified by ~tlon-get-clock-action~, using the Tlön labels configuration (~tlon-label-lookup~).

#+findex: tlon-get-clock-next-label
+ ~tlon-get-clock-next-label~ :: Determines the "next" label in the sequence defined by ~tlon-job-labels~, based on the label of the currently clocked action (~tlon-get-clock-label~). This relies on the order within the ~tlon-job-labels~ alist.

*** Utility Functions
:PROPERTIES:
:CUSTOM_ID: h:tlon-clock-utils
:END:

#+findex: tlon-next-value
+ ~tlon-next-value~ :: A generic helper function to find the value associated with a =PROPERTY= that comes *after* the item with the specified =VALUE= in an =ALIST=. Used by ~tlon-get-clock-next-label~.

#+findex: tlon-copy-buffer
+ ~tlon-copy-buffer~ :: Copies the entire content of a specified =FILE= (or the current buffer) to the kill ring.

#+findex: tlon-copy-region
+ ~tlon-copy-region~ :: Copies the text between positions =BEG= and =END= to the kill ring.

#+findex: tlon-set-paths-from-clock
+ ~tlon-set-paths-from-clock~ :: Retrieves the BibTeX key from the clocked task and uses Tlön metadata to find the file paths for both the original document and its corresponding translation. Returns these paths and the key as multiple values.

#+findex: tlon-set-windows
+ ~tlon-set-windows~ :: A utility function (likely requiring =window-extras= and =winum= packages) to open two specified files (=ORIGINAL-PATH= and =TRANSLATION-PATH=) in specific windows (window 1 and window 2, respectively), splitting the frame if necessary.

*** Variables
:PROPERTIES:
:CUSTOM_ID: h:tlon-clock-variables
:END:

#+vindex: tlon-key-regexp
+ ~tlon-key-regexp~ :: The constant regular expression used by ~tlon-get-clock-key~ to identify BibTeX keys within clocked task headings. It specifically looks for text enclosed in backticks, optionally followed by =.md=.

* Glossary Management (=tlon-glossary.el=)
:PROPERTIES:
:CUSTOM_ID: h:tlon-glossary
:END:

This module provides functions for managing a multilingual glossary stored in a JSON file. It allows users to edit entries, add translations, and extract the glossary in different formats for various recipients (humans, DeepL editor, DeepL API).

** Configuration
:PROPERTIES:
:CUSTOM_ID: h:tlon-glossary-config
:END:

*** Glossary Source File
:PROPERTIES:
:CUSTOM_ID: h:tlon-file-glossary-source
:END:
#+vindex: tlon-file-glossary-source
The constant ~tlon-file-glossary-source~ defines the path to the JSON file containing the master glossary data. By default, it points to =glossary.json= within the =babel-core= repository.

*** Glossary Recipients
:PROPERTIES:
:CUSTOM_ID: h:tlon-glossary-recipients
:END:
#+vindex: tlon-glossary-recipients
The constant ~tlon-glossary-recipients~ is an alist defining the email addresses associated with specific target languages for sharing human-readable glossaries. Each entry is a plist with =:language= (language code string) and =:email= (email address string).

#+begin_src emacs-lisp
(defconst tlon-glossary-recipients
  '((:language "fr" :email "tlon-french@googlegroups.com")
    (:language "it" :email "tlon-italian@googlegroups.com")))
#+end_src

** Commands
:PROPERTIES:
:CUSTOM_ID: h:tlon-glossary-commands
:END:

This section details the interactive commands provided by =tlon-glossary.el=.

*** Edit Glossary Entry
:PROPERTIES:
:CUSTOM_ID: h:tlon-edit-glossary
:END:
#+findex: tlon-edit-glossary
The command ~tlon-edit-glossary~ provides an interactive way to create or update entries in the glossary file (~tlon-file-glossary-source~).

1. It parses the existing glossary using ~tlon-parse-glossary~.
2. It prompts the user to choose an existing English term (using completion) or add a new one.
3. If the term is new:
   - It prompts the user to select the term type (=variable= or =invariant=) using ~tlon-select-term-type~.
   - It creates a new entry structure using ~tlon-create-entry~. For invariant terms, it automatically adds entries for all target languages, using the English term as the initial translation.
4. If the term exists or is newly created and is not of type =invariant=:
   - It calls ~tlon-edit-translation-in-entry~ to prompt the user for a target language and the corresponding translation for the selected English term. It updates the entry with the new or modified translation.
5. It updates the main glossary data structure with the modified or new entry using ~tlon-update-glossary~.
6. It writes the updated glossary back to the JSON file using ~tlon-write-data~.

*** Extract Glossary
:PROPERTIES:
:CUSTOM_ID: h:tlon-extract-glossary
:END:
#+findex: tlon-extract-glossary
The command ~tlon-extract-glossary~ extracts a language-specific glossary from the main JSON file and saves it in a format suitable for a specified recipient.

1. It prompts the user to select the target =LANGUAGE= using ~tlon-select-language~.
2. It prompts the user to select the =RECIPIENT= type (=human=, =deepl-editor=, or =deepl-api=) using completion.
3. It determines the target file path and extension based on the language and recipient using ~tlon-glossary-target-path~.
4. It reads the source glossary JSON file.
5. It creates or opens the target file and inserts the formatted glossary content using ~tlon-insert-formatted-glossary~, filtering and formatting entries based on the recipient:
   - =human=: Includes only "variable" type entries, formatted as CSV (="Source","Target"=).
   - =deepl-editor=: Includes all entries, formatted as CSV (="Source","Target","EN","LANG"=).
   - =deepl-api=: Includes all entries, formatted as TSV (=Source\tTarget=).
6. It saves the target file.
7. If the recipient is =human=, it asks the user if they want to share the extracted glossary via email using ~tlon-share-glossary~.
8. For other recipients, it messages the path to the extracted file.

*** Share Glossary
:PROPERTIES:
:CUSTOM_ID: h:tlon-share-glossary
:END:
#+findex: tlon-share-glossary
The command ~tlon-share-glossary~ sends an extracted glossary file as an email attachment to the designated translators for a specific language.

1. It prompts the user to select the glossary =ATTACHMENT= file (defaulting to the downloads directory).
2. It prompts the user to select the =LANGUAGE= of the glossary (unless provided as an argument).
3. It looks up the recipient email address for the language in ~tlon-glossary-recipients~ using ~tlon-lookup~.
4. It looks up the full language name (e.g., "French") using ~tlon-lookup~ on ~tlon-languages-properties~ and sets the ~tlon-email-language~ variable.
5. It calls ~tlon-email-send~ with the ="share-glossary.org"= template, the recipient email, and the attachment path.

*** Glossary Menu
:PROPERTIES:
:CUSTOM_ID: h:tlon-glossary-menu
:END:
#+findex: tlon-glossary-menu
The command ~tlon-glossary-menu~ activates a =transient= menu interface providing quick access to the main glossary functions:
+ =e= :: Edit glossary entry (~tlon-edit-glossary~)
+ =x= :: Extract glossary (~tlon-extract-glossary~)
+ =s= :: Share glossary (~tlon-share-glossary~)

** Internal Functions and Variables
:PROPERTIES:
:CUSTOM_ID: h:tlon-glossary-internals
:END:

This section lists non-interactive functions and variables used internally or potentially useful for advanced customization.

*** Glossary Data Handling
:PROPERTIES:
:CUSTOM_ID: h:tlon-glossary-data
:END:

#+findex: tlon-parse-glossary
+ ~tlon-parse-glossary~ :: Reads and parses the JSON glossary file specified by ~tlon-file-glossary-source~ into an Emacs Lisp alist using ~tlon-read-json~.

#+findex: tlon-get-english-terms
+ ~tlon-get-english-terms~ :: Extracts a list of all English terms (the =en= value) from the parsed glossary alist. Used for completion in ~tlon-edit-glossary~.

#+findex: tlon-find-entry-by-term
+ ~tlon-find-entry-by-term~ :: Searches the parsed glossary alist for an entry whose English term (=en= value) matches the given =TERM=. Returns the matching entry alist or nil.

#+findex: tlon-select-term-type
+ ~tlon-select-term-type~ :: Prompts the user with completion to select a term type (=variable= or =invariant=) and returns the selected string.

#+findex: tlon-create-entry
+ ~tlon-create-entry~ :: Creates a new glossary entry alist for a given English =TERM= and =TYPE=. If the type is =invariant=, it pre-populates translations for all ~tlon-project-target-languages~ with the English term itself.

#+findex: tlon-edit-translation-in-entry
+ ~tlon-edit-translation-in-entry~ :: Interactively prompts the user to select a target language and provide or update the translation for the given English =TERM= within the provided =ENTRY= alist. Returns the modified entry.

#+findex: tlon-update-glossary
+ ~tlon-update-glossary~ :: Takes the main glossary alist, a potentially modified =ENTRY=, and the corresponding English =TERM=. If an entry for =TERM= already exists in the glossary, it replaces it with =ENTRY=. If not, it appends =ENTRY= to the glossary. Returns the updated glossary alist.

*** Glossary Extraction Formatting
:PROPERTIES:
:CUSTOM_ID: h:tlon-glossary-extraction
:END:

#+findex: tlon-glossary-target-path
+ ~tlon-glossary-target-path~ :: Determines the full output file path for an extracted glossary based on the target =LANGUAGE= and =RECIPIENT=. It sets the file extension to =.csv= for =human= and =deepl-editor=, and =.tsv= for =deepl-api=. Uses ~tlon-glossary-make-file~ internally.

#+findex: tlon-glossary-make-file
+ ~tlon-glossary-make-file~ :: Constructs the filename (e.g., =EN-FR.csv=) and combines it with the user's download directory path (~paths-dir-downloads~).

#+findex: tlon-insert-formatted-glossary
+ ~tlon-insert-formatted-glossary~ :: Iterates through the parsed =JSON= glossary data. For each entry, it extracts the source (=en=) and target (=language=) terms. Based on the =RECIPIENT=, it formats the entry as CSV or TSV and inserts it into the current buffer. For =human= recipients, it only includes entries of type =variable=.

*** Git Integration (Currently Unused/TODO)
:PROPERTIES:
:CUSTOM_ID: h:tlon-glossary-git
:END:

#+findex: tlon-glossary-prompt-for-explanation
+ ~tlon-glossary-prompt-for-explanation~ :: (TODO) Prompts the user for an optional explanation of a glossary change, intended for commit messages.

#+findex: tlon-glossary-commit
+ ~tlon-glossary-commit~ :: (TODO) Intended to handle the Git workflow for glossary changes: pulling, staging the glossary file, committing with a formatted message (including action, term, and optional explanation), and pushing. Requires =magit= functions. Currently marked as unused and needing fixes.

* Dictionary Functionality (=tlon-dict.el=)
:PROPERTIES:
:CUSTOM_ID: h:tlon-dict
:END:

This module integrates with the external =reverso.el= package to provide dictionary-related features, specifically fetching synonyms, while ensuring that the language context aligns with the Tlön workflow.

** Dependencies
:PROPERTIES:
:CUSTOM_ID: h:tlon-dict-dependencies
:END:

This module requires the =reverso= package to be installed and available.

** Commands
:PROPERTIES:
:CUSTOM_ID: h:tlon-dict-commands
:END:

*** Get Synonyms via Reverso
:PROPERTIES:
:CUSTOM_ID: h:tlon-reverso-get-synonyms
:END:
#+findex: tlon-reverso-get-synonyms
The command ~tlon-reverso-get-synonyms~ fetches synonyms for the word currently at point using the =reverso.el= package.

Crucially, it overrides the default language selection mechanism of =reverso.el=. Instead, it determines the language of the current file using ~tlon-get-language-in-file~, looks up the corresponding language code recognized by =reverso.el= using Tlön's configuration (~tlon-lookup~), and passes this language code to the underlying =reverso--get-synonyms= function.

It prompts the user for the word, defaulting to the word at point (~thing-at-point 'word~). The results are displayed in a dedicated Reverso buffer, similar to how =reverso.el= typically operates.

** Transient Menu
:PROPERTIES:
:CUSTOM_ID: h:tlon-dict-menu
:END:
#+findex: tlon-dict-menu
The command ~tlon-dict-menu~ activates a =transient= menu interface for dictionary-related commands.

Currently, it offers one option:
+ =s= :: Calls ~tlon-reverso-get-synonyms~ to fetch synonyms for the word at point.

* Image Processing (=tlon-images.el=)
:PROPERTIES:
:CUSTOM_ID: h:tlon-images
:END:

This module provides functionality for processing images, primarily using the external =ImageMagick= command-line tool. It allows for operations like reducing brightness, inverting colors, and making images non-transparent. It also integrates with the =invertornot.com= API to determine if an image's colors can be safely inverted.

** Dependencies
:PROPERTIES:
:CUSTOM_ID: h:tlon-images-dependencies
:END:

+ =ImageMagick= :: Must be installed and accessible in the system's PATH for image processing commands to work.
+ =transient= :: Required for the menu interface.
+ =window-extras= :: Used by ~tlon-images-maybe-open-after-processing~ for window management.

** User Options
:PROPERTIES:
:CUSTOM_ID: h:tlon-images-options
:END:

#+vindex: tlon-images-default-brightness-reduction
+ ~tlon-images-default-brightness-reduction~ :: Default percentage (integer) by which to reduce image brightness when using ~tlon-images-reduce-brightnesss~ without specifying a percentage. Defaults to 20.

#+vindex: tlon-images-open-after-processing
+ ~tlon-images-open-after-processing~ :: Boolean flag. If non-nil (the default), the original (copied as light theme) and processed (dark theme) images will be opened in separate windows after processing via ~tlon-images-reduce-brightnesss~ or ~tlon-images-invert-colors~. Uses ~tlon-images-maybe-open-after-processing~.

#+vindex: tlon-images-process-without-asking
+ ~tlon-images-process-without-asking~ :: Boolean flag. If non-nil, commands like ~tlon-images-reduce-brightnesss~ will process the image at point (in Dired) or the current buffer's file without prompting for confirmation via ~tlon-images-read-image~. Defaults to nil.

** Commands
:PROPERTIES:
:CUSTOM_ID: h:tlon-images-commands
:END:

*** Auto Process Image
:PROPERTIES:
:CUSTOM_ID: h:tlon-images-auto-process
:END:
#+findex: tlon-images-auto-process
The command ~tlon-images-auto-process~ attempts to intelligently process an image for a dark theme.

1. It prompts for the =IMAGE= file using ~tlon-images-read-image~.
2. It determines the output filename using ~tlon-images-get-themed-file-name~ with the =dark= theme.
3. It checks if the image can be safely inverted using ~tlon-images-can-invert-p~ (which calls the =invertornot.com= API).
4. If inversion is safe, it calls ~tlon-images-invert-colors~.
5. Otherwise, it calls ~tlon-images-reduce-brightnesss~ using the default reduction percentage.

*** Reduce Image Brightness
:PROPERTIES:
:CUSTOM_ID: h:tlon-images-reduce-brightnesss
:END:
#+findex: tlon-images-reduce-brightnesss
The command ~tlon-images-reduce-brightnesss~ reduces the brightness of an image using ImageMagick.

1. It prompts for the =SOURCE= image using ~tlon-images-read-image~ (unless provided).
2. It determines the =TARGET= filename (defaulting to a dark-themed version via ~tlon-images-get-themed-file-name~) unless provided.
3. It prompts for the reduction =PERCENT= (defaulting to ~tlon-images-default-brightness-reduction~) unless provided. Note: The percentage passed to ImageMagick's =-modulate= is calculated as =100 - PERCENT=.
4. It constructs the ImageMagick command using ~tlon-imagemagick-reduce-brightness~.
5. It calls ~tlon-images-process-image~ to execute the command, copy the original to a light-themed file, handle output, and potentially open the images.

*** Invert Image Colors
:PROPERTIES:
:CUSTOM_ID: h:tlon-images-invert-colors
:END:
#+findex: tlon-images-invert-colors
The command ~tlon-images-invert-colors~ inverts the colors of an image using ImageMagick.

1. It prompts for the =SOURCE= image using ~tlon-images-read-image~ (unless provided).
2. It determines the =TARGET= filename (defaulting to a dark-themed version via ~tlon-images-get-themed-file-name~) unless provided.
3. It constructs the ImageMagick command using ~tlon-imagemagick-invert-colors~.
4. It calls ~tlon-images-process-image~ to execute the command, copy the original to a light-themed file, handle output, and potentially open the images.

*** Make Image Non-Transparent
:PROPERTIES:
:CUSTOM_ID: h:tlon-images-make-nontransparent
:END:
#+findex: tlon-images-make-nontransparent
The command ~tlon-images-make-nontransparent~ removes transparency from an image, replacing it with a solid background color using ImageMagick.

1. It prompts for the =SOURCE= image using ~tlon-images-read-image~ (unless provided).
2. It determines the =TARGET= filename (defaulting to the source file itself, thus overwriting it) unless provided.
3. It prompts for the =BACKGROUND= color (defaulting to "white") unless provided.
4. It constructs the ImageMagick command using ~tlon-imagemagick-make-nontransparent~.
5. It executes the command using =shell-command-to-string=.
6. It calls ~tlon-images-handle-output~ to display success or error messages.

*** Transient Menu
:PROPERTIES:
:CUSTOM_ID: h:tlon-images-menu
:END:
#+findex: tlon-images-menu
The command ~tlon-images-menu~ activates a =transient= menu interface for image processing.

It provides the following groups and commands:
+ *Commands*:
  + =a= :: Auto process (~tlon-images-auto-process~)
  + =r= :: Reduce brightness (~tlon-images-reduce-brightnesss~)
  + =i= :: Invert colors (~tlon-images-invert-colors~)
  + =n= :: Make non-transparent (~tlon-images-make-nontransparent~)
+ *Options*:
  + =-o= :: Toggle opening images after processing (~tlon-images-toggle-open-after-processing~ infix, modifies ~tlon-images-open-after-processing~)
  + =-p= :: Toggle processing without asking (~tlon-images-toggle-process-without-asking~ infix, modifies ~tlon-images-process-without-asking~)
  + =-r= :: Set brightness reduction percentage (~tlon-images-brightness-reduction-infix~, modifies ~tlon-images-default-brightness-reduction~)

** Internal Functions and Variables
:PROPERTIES:
:CUSTOM_ID: h:tlon-images-internals
:END:

This section lists non-interactive functions, variables, and constants used internally or potentially useful for advanced customization.

*** ImageMagick Command Constants
:PROPERTIES:
:CUSTOM_ID: h:tlon-images-imagemagick-consts
:END:

#+vindex: tlon-imagemagick-reduce-brightness
+ ~tlon-imagemagick-reduce-brightness~ :: Format string for the =magick= command to reduce brightness using =-modulate=. Placeholders: %1$s (input), %2$s (output), %3$s (brightness percentage for modulate).

#+vindex: tlon-imagemagick-invert-colors
+ ~tlon-imagemagick-invert-colors~ :: Format string for the =magick= command to invert colors using =-channel RGB -negate=. Placeholders: %s (input), %s (output).

#+vindex: tlon-imagemagick-make-nontransparent
+ ~tlon-imagemagick-make-nontransparent~ :: Format string for the =magick= command to remove transparency using =-background= and =-flatten=. Placeholders: %1$s (input), %2$s (output), %3$s (background color).

*** InvertOrNot API Integration
:PROPERTIES:
:CUSTOM_ID: h:tlon-images-invertornot
:END:

#+vindex: tlon-invertornot-generic-endpoint
+ ~tlon-invertornot-generic-endpoint~ :: Base URL for the =invertornot.com= API.

#+findex: tlon-images-post-file-to-invertornot
+ ~tlon-images-post-file-to-invertornot~ :: Sends an image =FILE= to the =invertornot.com/api/file= endpoint using a multipart/form-data POST request. Returns the parsed JSON response via ~tlon-images-handle-synchronous-response~.

#+findex: tlon-images-post-url-to-invertornot
+ ~tlon-images-post-url-to-invertornot~ :: Sends an =IMAGE-URL= to the =invertornot.com/api/url= endpoint using a JSON POST request. Returns the parsed JSON response via ~tlon-images-handle-synchronous-response~.

#+findex: tlon-images-handle-synchronous-response
+ ~tlon-images-handle-synchronous-response~ :: Helper function to process the buffer returned by =url-retrieve-synchronously=, extract the JSON payload, and parse it into an alist.

#+findex: tlon-images-can-invert-p
+ ~tlon-images-can-invert-p~ :: Takes an =IMAGE= file path, sends it to the =invertornot.com= API using ~tlon-images-post-file-to-invertornot~, and checks the =invert= field in the response. Returns =t= if the value is 1, =nil= if 0, and signals an error otherwise.

*** Helper Functions
:PROPERTIES:
:CUSTOM_ID: h:tlon-images-helpers
:END:

#+findex: tlon-images-read-image
+ ~tlon-images-read-image~ :: Prompts the user for an image file path. If called within Dired, defaults to the file at point. If the current buffer has a file, defaults to that. If ~tlon-images-process-without-asking~ is non-nil, it skips the prompt and uses the default directly.

#+findex: tlon-images-process-image
+ ~tlon-images-process-image~ :: Core utility for processing images. Takes =SOURCE=, =TARGET=, the ImageMagick =COMMAND= string, and a =MESSAGE-FMT= string.
  1. Executes the =COMMAND= using =shell-command-to-string=.
  2. Copies the =SOURCE= file to a light-themed filename (using ~tlon-images-get-themed-file-name~).
  3. Calls ~tlon-images-maybe-open-after-processing~ with the light and dark themed files.
  4. Calls ~tlon-images-handle-output~ with the command output and the formatted message.

#+findex: tlon-images-handle-output
+ ~tlon-images-handle-output~ :: Checks the =OUTPUT= string from a shell command. If empty, displays the success =MESSAGE=. If non-empty, signals a user error with the output content.

#+findex: tlon-images-get-themed-file-name
+ ~tlon-images-get-themed-file-name~ :: Takes a =FILE= path and a =THEME= symbol (=light= or =dark=). Returns a new filename with =-[theme].ext= appended before the extension (e.g., =image.png= becomes =image-dark.png=).

#+findex: tlon-images-maybe-open-after-processing
+ ~tlon-images-maybe-open-after-processing~ :: If ~tlon-images-open-after-processing~ is non-nil, it opens the =ORIGINAL= (light theme) and =PROCESSED= (dark theme) files in separate windows, splitting the frame if necessary using =window-extras= functions.

*** Transient Infix Commands
:PROPERTIES:
:CUSTOM_ID: h:tlon-images-transient-infixes
:END:

These functions define the behavior of the options within the ~tlon-images-menu~.

#+findex: tlon-images-brightness-reduction-infix
+ ~tlon-images-brightness-reduction-infix~ :: Reads a number from the user to set the local value of ~tlon-images-default-brightness-reduction~ for the current menu invocation.

#+findex: tlon-images-toggle-open-after-processing
+ ~tlon-images-toggle-open-after-processing~ :: Toggles the boolean value of ~tlon-images-open-after-processing~ for the current menu invocation using ~tlon-transient-toggle-variable-value~.

#+findex: tlon-images-toggle-process-without-asking
+ ~tlon-images-toggle-process-without-asking~ :: Toggles the boolean value of ~tlon-images-process-without-asking~ for the current menu invocation using ~tlon-transient-toggle-variable-value~.

* Job Management (=tlon-jobs.el=)
:PROPERTIES:
:CUSTOM_ID: h:tlon-jobs
:END:

This module manages the workflow for processing "Babel jobs," which typically involve translating documents. It integrates Org mode's clocking mechanism, GitHub issues (via =orgit-forge=), and Git version control (via =magit=) to track the progress of jobs through various phases like processing, translation, revision, checking, and review.

** Configuration
:PROPERTIES:
:CUSTOM_ID: h:tlon-jobs-config
:END:

*** Job Labels and Phases
:PROPERTIES:
:CUSTOM_ID: h:tlon-job-labels
:END:
#+vindex: tlon-job-labels
The constant ~tlon-job-labels~ defines the different stages or phases a job goes through. It's an alist where each element represents a phase and contains properties like the display label, the action verb associated with the phase, and the default assignee for that phase.

#+begin_src emacs-lisp
(defconst tlon-job-labels
  '((:label "Awaiting processing" :action "Process" :assignee "worldsaround")
    (:label "Awaiting translation" :action "Translate" :assignee "")
    ;; ... other phases ...
    (:label "Published" :action "Publish" :assignee "")))
#+end_src

This structure drives the workflow logic, determining the next step and assignee after a phase is completed.

*** Org ID Constants
:PROPERTIES:
:CUSTOM_ID: h:tlon-jobs-org-ids
:END:

#+vindex: tlon-jobs-manual-processing-id
+ ~tlon-jobs-manual-processing-id~ :: The Org ID of the specific heading within =manual.org= that contains instructions relevant to the "processing" phase. Used by ~tlon-jobs-initialize-processing~.

#+vindex: tlon-jobs-id
+ ~tlon-jobs-id~ :: The Org ID of the main "jobs" heading in the central =jobs.org= file. This file serves as the primary tracker for all jobs.

*** Jobs File Variable
:PROPERTIES:
:CUSTOM_ID: h:tlon-jobs-file-var
:END:
#+vindex: tlon-jobs-file
The variable ~tlon-jobs-file~ holds the path to the =jobs.org= file. It is set dynamically by ~tlon-jobs-get-file~ and should not be configured manually.

** Commands
:PROPERTIES:
:CUSTOM_ID: h:tlon-jobs-commands
:END:

This section details the interactive commands provided by =tlon-jobs.el=.

*** Start or Finish Job Phase
:PROPERTIES:
:CUSTOM_ID: h:tlon-jobs-start-or-finish-phase
:END:
#+findex: tlon-jobs-start-or-finish-phase
The command ~tlon-jobs-start-or-finish-phase~ is the central command for advancing the job workflow. It determines the current context (Org mode for starting, Markdown mode for finishing) and the action associated with the currently clocked task (~tlon-get-clock-action~).

- *Initialization (in Org mode):*
  1. Clocks into the task.
  2. Saves the buffer.
  3. Determines the initialization function based on the action (e.g., ~tlon-jobs-initialize-processing~).
  4. Calls the general ~tlon-jobs-initialize~ function, which performs common setup tasks:
     - Checks the associated repository's label and assignee (~tlon-check-label-and-assignee~).
     - Ensures the repository is on the "main" branch (~tlon-check-branch~).
     - Pulls the latest changes from upstream (~magit-pull-from-upstream~).
     - Sets up the window configuration with original and translation files (~tlon-set-windows~).
     - Opens the associated GitHub issue (~orgit-topic-open~).
     - Copies the original buffer content.
  5. Calls the specific initialization function for the current phase (e.g., opening the manual for processing, opening DeepL for translation, setting up diffs for review).

- *Finalization (in Markdown mode):*
  1. Closes split mode if active (~tlon-split-mode -1~).
  2. Saves the buffer.
  3. Calls ~tlon-jobs-finalize~, which performs common finalization tasks:
     - Checks the repository branch and label/assignee.
     - Performs phase-specific checks (e.g., prompts for Jinx/Flycheck confirmation after translation).
     - Saves the modified original (if processing) or translation file.
     - Commits and pushes the changes for the translation file (and original if processing) using ~tlon-commit-and-push~.
     - Updates the associated GitHub issue: sets the next label (~tlon-get-clock-next-label~) and assignee (~tlon-jobs-get-next-assignee~), potentially closing the issue after the "Review" phase using ~tlon-jobs-act-on-issue~.
     - Updates the corresponding TODO items in =jobs.org= and the main TODO file using ~tlon-jobs-finalize-set-todos~.

*** Create Job
:PROPERTIES:
:CUSTOM_ID: h:tlon-create-job
:END:
#+findex: tlon-create-job
The command ~tlon-create-job~ orchestrates the entire process of creating a new job based on a BibTeX entry at point in an Ebib buffer.

1. Imports the document associated with the BibTeX entry using ~tlon-import-document~, which returns the BibTeX key.
2. Creates the initial translation file structure using ~tlon-create-translation-file~.
3. Creates the necessary records for the job (GitHub issue and =jobs.org= heading) using ~tlon-create-record-for-job~.

*** Create Job Record
:PROPERTIES:
:CUSTOM_ID: h:tlon-create-record-for-job
:END:
#+findex: tlon-create-record-for-job
The command ~tlon-create-record-for-job~ creates the tracking records for a job based on a BibTeX =KEY=. If =KEY= is not provided, it attempts to find it in the current buffer (Markdown or Ebib).

1. Creates a GitHub issue titled "Job: `KEY`" using ~tlon-create-issue-from-key~.
2. Creates a corresponding heading in =jobs.org= using ~tlon-create-heading-for-job~, optionally committing the change.

*** Create Heading in jobs.org
:PROPERTIES:
:CUSTOM_ID: h:tlon-create-heading-for-job
:END:
#+findex: tlon-create-heading-for-job
The command ~tlon-create-heading-for-job~ adds a new heading to the =jobs.org= file for tracking a specific job based on its BibTeX =KEY=.

1. Determines the =KEY= (from argument or current buffer).
2. Formats the heading as =[cite:@KEY]=.
3. Finds the associated repository and its abbreviation (~tlon-repo-lookup~).
4. Opens =jobs.org= (finding the buffer or file).
5. If the heading doesn't exist:
   - Navigates to the main jobs section (using ~tlon-jobs-id~).
   - Inserts the new heading.
   - Sets the TODO state to "TODO".
   - Adds the repository abbreviation as a tag.
   - Sorts the headings in the file (~tlon-sort-headings~).
   - Saves the buffer.
6. Optionally commits the change to =jobs.org= using ~tlon-commit-and-push~ if =COMMIT= is non-nil.

*** Transient Menu
:PROPERTIES:
:CUSTOM_ID: h:tlon-jobs-menu
:END:
#+findex: tlon-jobs-menu
The command ~tlon-jobs-menu~ activates a =transient= menu interface for job-related operations.

It provides the following groups and commands:
+ *Job phases*:
  + =j= :: Start or finish phase (~tlon-jobs-start-or-finish-phase~)
+ *Job creation*:
  + =c c= :: Create job (~tlon-create-job~)
  + =c d= :: 1 Import document (~tlon-import-document~)
  + =c f= :: 2 Create translation file (~tlon-create-translation-file~)
  + =c r= :: 3 Create record for job (~tlon-create-record-for-job~)
+ *Add or modify*:
  + =a s= :: Section correspondence (~tlon-section-correspondence-dwim~)
  + =a u= :: URL correspondence (~tlon-edit-url-correspondences~)
+ *jobs.org*:
  + =r= :: Create record (~tlon-create-record-for-job~)
  + =h= :: Create heading (~tlon-create-heading-for-job~)
  + =t= :: Sort headings (~tlon-sort-headings~)

** Internal Functions and Variables
:PROPERTIES:
:CUSTOM_ID: h:tlon-jobs-internals
:END:

This section lists non-interactive functions and variables used internally or potentially useful for advanced customization.

*** File and Path Management
:PROPERTIES:
:CUSTOM_ID: h:tlon-jobs-files
:END:

#+findex: tlon-jobs-get-file
+ ~tlon-jobs-get-file~ :: Retrieves the path to the =jobs.org= file, using the Org ID ~tlon-jobs-id~ and caching the result in ~tlon-jobs-file~ via ~tlon-get-or-set-org-var~.

*** Job Phase Logic
:PROPERTIES:
:CUSTOM_ID: h:tlon-jobs-phase-logic
:END:

#+findex: tlon-jobs-get-action-in-label
+ ~tlon-jobs-get-action-in-label~ :: Extracts the action verb (e.g., "Process", "Translate") from a job phase =LABEL= string (e.g., "Awaiting processing").

#+findex: tlon-jobs-initialize
+ ~tlon-jobs-initialize~ :: Performs common setup tasks when starting any job phase (checking repo, pulling, setting up windows, opening issue, copying buffer). Takes the specific phase initialization function (=FUN=) as an argument and calls it after the common setup.

#+findex: tlon-jobs-finalize
+ ~tlon-jobs-finalize~ :: Performs common cleanup and update tasks when finishing any job phase (checking repo, committing files, updating GitHub issue label/assignee, updating TODOs).

#+findex: tlon-jobs-get-next-assignee
+ ~tlon-jobs-get-next-assignee~ :: Determines the assignee for the *next* phase. It considers the current user and the designated assignee for the current phase versus the next phase, potentially assigning a substitute if the current user isn't the designated one for the current phase.

#+findex: tlon-jobs-initialize-processing
+ ~tlon-jobs-initialize-processing~ :: Specific setup for the "Process" phase: opens the original file and the relevant section in =manual.org= (using ~tlon-jobs-manual-processing-id~), narrows the view, and opens the issue.

#+findex: tlon-jobs-initialize-translation
+ ~tlon-jobs-initialize-translation~ :: Specific setup for the "Translate" phase: opens the DeepL application using ~macos-open-app~.

#+findex: tlon-jobs-initialize-revision
+ ~tlon-jobs-initialize-revision~ :: Specific setup for the "Revise" phase: activates split mode (~tlon-split-mode~).

#+findex: tlon-jobs-initialize-check
+ ~tlon-jobs-initialize-check~ :: Specific setup for the "Check" phase: rearranges windows, starts Markdown preview, and initiates text-to-speech using ~read-aloud-buf~.

#+findex: tlon-jobs-initialize-review
+ ~tlon-jobs-initialize-review~ :: Specific setup for the "Review" phase: opens an =ediff= session showing changes since the last user commit (~tlon-log-buffer-latest-user-commit-ediff~), sets up =jinx= for spell/grammar checking in the target language, and moves to the beginning of the buffer.

*** Issue and TODO Interaction
:PROPERTIES:
:CUSTOM_ID: h:tlon-jobs-issue-todo
:END:

#+findex: tlon-jobs-act-on-issue
+ ~tlon-jobs-act-on-issue~ :: Updates a GitHub issue associated with an =ORIGINAL-KEY=. It finds the issue (using ~tlon-issue-lookup~), sets the specified =LABEL= and =ASSIGNEE= using ~tlon-set-labels~ and ~tlon-set-assignee~, and optionally closes the issue if =CLOSE= is non-nil.

#+findex: tlon-jobs-finalize-set-todos
+ ~tlon-jobs-finalize-set-todos~ :: Marks the relevant TODO items as DONE during the finalization process. It marks the clocked task itself as DONE in the main TODO file (~tlon-get-todos-jobs-file~). For "Review" and "Check" phases, it also marks the parent TODO as DONE. For the "Review" phase, it additionally marks the corresponding job heading in =jobs.org= as DONE, sorts the headings, and commits the change.

*** jobs.org Helpers
:PROPERTIES:
:CUSTOM_ID: h:tlon-jobs-org-helpers
:END:

#+findex: tlon-jobs-get-key-in-heading
+ ~tlon-jobs-get-key-in-heading~ :: Extracts the BibTeX key from the Org heading at point, assuming the format =[cite:@KEY]= or ``Job: `KEY`.md``.

#+findex: tlon-jobs-goto-heading
+ ~tlon-jobs-goto-heading~ :: Moves the point to the heading corresponding to the given BibTeX =KEY= within the =jobs.org= file.

* Indices
:PROPERTIES:
:CUSTOM_ID: h:indices
:END:

** Function index
:PROPERTIES:
:INDEX: fn
:CUSTOM_ID: h:fn-index
:END:

** Variable index
:PROPERTIES:
:INDEX: vr
:CUSTOM_ID: h:vr-index
:END:

** Concept index
:PROPERTIES:
:INDEX: cp
:CUSTOM_ID: h:cp-index
:END:

* local variables                                                  :noexport:
(Note that the local variables below will still be exported to the ~info~ file, unfortunately. It looks like they are not considered part of this heading.)

# Local Variables:
# eval: (add-hook 'before-save-hook 'org-texinfo-export-to-info nil t)
# End:
