#+title: tlon - Newsletter Functionality
#+author: Pablo Stafforini
#+EXCLUDE_TAGS: noexport
#+language: en
#+options: ':t toc:nil author:t email:t num:t
#+startup: content
#+texinfo_header: @set MAINTAINERSITE @uref{https://github.com/tlon-team/tlon,maintainer webpage}
#+texinfo_header: @set MAINTAINER Pablo Stafforini
#+texinfo_header: @set MAINTAINEREMAIL @email{pablo@tlon.team}
#+texinfo_header: @set MAINTAINERCONTACT @uref{mailto:pablo@tlon.team,contact the maintainer}
#+texinfo: @insertcopying
* Newsletter Functionality (=tlon-newsletter.el=)
:PROPERTIES:
:CUSTOM_ID: h:tlon-newsletter
:END:

This module provides functionality for creating newsletter issues using AI.

** User Options
:PROPERTIES:
:CUSTOM_ID: h:tlon-newsletter-options
:END:

#+vindex: tlon-newsletter-model
+ ~tlon-newsletter-model~ :: Model to use for creating newsletter issues with ~tlon-newsletter-create-issue~.
  #+begin_src emacs-lisp
  (setq tlon-newsletter-model nil) ; Use default gptel model
  #+end_src

** Commands
:PROPERTIES:
:CUSTOM_ID: h:tlon-newsletter-commands
:END:

*** Creating Newsletter Issues
:PROPERTIES:
:CUSTOM_ID: h:tlon-newsletter-create-issue
:END:
#+findex: tlon-newsletter-create-issue
The command ~tlon-newsletter-create-issue~ automates the drafting of a new newsletter issue.

It works as follows:
1. It locates the "boletin" repository (as configured in ~tlon-repos~).
2. It targets the next month's issue file (named ~YYYY-MM.md~) within the ~numeros/~ subdirectory. If the file exists it is used; otherwise it is created. The file is expected to contain a list of items (URLs or plain text), one per line.
3. The content of this file is passed to the AI.
4. The AI is prompted to process each line:
   - If the line is a URL, the AI uses its web browsing tools (search and fetch content) to access the URL's content and then writes a one-paragraph summary in Spanish.
   - If the line is plain text, the AI writes a one-paragraph summary of that text in Spanish.
5. The AI then structures all the summaries into a complete newsletter draft in Markdown format. The newsletter is in Spanish and has three main sections, each introduced by a level-2 heading:
   - ~## Eventos~
   - ~## Anuncios~
   - ~## Artículos~
   - ~## Oportunidades~
   The AI decides which section is appropriate for each summarized item.
6. Within each section, each item is presented with a level-3 heading (generated by the AI to describe the item's topic) followed by the one-paragraph summary.
7. The resulting newsletter draft replaces the content of the original input file (the next month's issue file in the ~numeros/~ subdirectory, created if missing). The updated file is then opened for review.

This command requires the AI to have web access capabilities, which are enabled by passing the ~gptel-tool-search~ and ~gptel-tool-fetch-content~ tools to the AI request.

** Helper functions
:PROPERTIES:
:CUSTOM_ID: h:tlon-newsletter-helpers
:END:
#+findex: tlon-newsletter-get-spanish-month
~tlon-newsletter-get-month~ converts a date string in ~"yyyy-mm-dd"~ format, such as
~\"2025-08-25\"~ to its Spanish month name ~\"agosto\"~ using Emacs’ native
~format-time-string~ so the output respects the current locale.

#+findex: tlon-newsletter--next-year-month
~tlon-newsletter--next-year-month~ returns a cons cell ~(YEAR . MONTH)~ for the
next calendar month. It accepts an optional ~TIME~ argument to compute relative
to a specific time value, which is useful for testing.

** Transient Menu
:PROPERTIES:
:CUSTOM_ID: h:tlon-newsletter-menu
:END:
#+findex: tlon-newsletter-menu
The command ~tlon-newsletter-menu~ displays a =transient= menu interface for newsletter functionality.

It allows for:
- Creating a new newsletter issue (~tlon-newsletter-create-issue~).
- Selecting a custom AI model for the task via the "Model" option, which controls the ~tlon-newsletter-model~ variable.
