#+title: tlon - File Translation
#+author: Pablo Stafforini
#+EXCLUDE_TAGS: noexport
#+language: en
#+options: ':t toc:nil author:t email:t num:t
#+startup: content
#+texinfo_header: @set MAINTAINERSITE @uref{https://github.com/tlon-team/tlon,maintainer webpage}
#+texinfo_header: @set MAINTAINER Pablo Stafforini
#+texinfo_header: @set MAINTAINEREMAIL @email{pablo@tlon.team}
#+texinfo_header: @set MAINTAINERCONTACT @uref{mailto:pablo@tlon.team,contact the maintainer}
#+texinfo: @insertcopying

* File Translation (=tlon-translate.el=)
:PROPERTIES:
:CUSTOM_ID: h:tlon-translate
:END:

This module provides functions for translating entire files using various translation engines.

** Dependencies
:PROPERTIES:
:CUSTOM_ID: h:tlon-translate-dependencies
:END:

+ =tlon-core=
+ =tlon-counterpart=
+ =tlon-deepl=
+ =transient=
+ =bibtex=

** Configuration
:PROPERTIES:
:CUSTOM_ID: h:tlon-translate-config
:END:

#+vindex: tlon-translation-engine
+ ~tlon-translation-engine~ :: Specifies the translation engine to use. Currently, the only supported value is ='deepl=.
#+vindex: tlon-translate-revise-errors-model
+ ~tlon-translate-revise-errors-model~ :: Model to use for spotting errors in translations.
#+vindex: tlon-translate-revise-flow-model
+ ~tlon-translate-revise-flow-model~ :: Model to use for improving the flow of translations.
#+vindex: tlon-translate-revise-commit-changes
+ ~tlon-translate-revise-commit-changes~ :: Whether to commit changes after an AI revision.
#+vindex: tlon-translate-revise-chunk-size
+ ~tlon-translate-revise-chunk-size~ :: Number of aligned paragraphs to send per AI revision request (default 10).
#+vindex: tlon-translate-revise-max-parallel
+ ~tlon-translate-revise-max-parallel~ :: Maximum number of paragraph-chunk revision requests to dispatch concurrently (default 3).
+ ~tlon-translate-restrict-revision-to-paragraphs~ :: When non-nil, restrict AI revision to the inclusive paragraph range =(START . END)=.  Nil (default) means revise the whole file.
+ ~tlon-translate-revise-stream~ :: When non-nil, AI responses are streamed; when nil (default) each chunk triggers a single callback on completion.

** Commands
:PROPERTIES:
:CUSTOM_ID: h:tlon-translate-commands
:END:

#+findex: tlon-translate-file
+ ~tlon-translate-file~ :: Translates a file into a specified language.
  1. Prompts for the source =FILE= to translate, defaulting to the file in the current buffer.
  2. Prompts for the target =LANG= (language code).
  3. Determines the path for the translated file. It first checks if a counterpart file for the target language already exists using ~tlon-get-counterpart-in-originals~.  If none exists, it translates the original title with ~tlon-translate-text~, slugifies it using ~simple-extras-slugify~, and proposes that as the default filename.
  4. If a counterpart exists, it asks the user whether to overwrite it. If the user declines, they are prompted for a new file path.
  5. If no counterpart file is found, it checks for a counterpart directory. If one exists, it prompts the user to save the file in that directory, defaulting to the slugified translated filename. Otherwise, it prompts for a full file path.
  6. Based on the value of ~tlon-translation-engine~, it calls the appropriate translation function (e.g., ~tlon-deepl-translate~).
  7. The content of the source file is read, translated, and then written to the target file, which is then opened.

#+findex: tlon-translate-missing-abstracts
+ ~tlon-translate-missing-abstracts~ :: Translate abstracts that are missing from two sources:
  - (I) Internal DB translations: iterate over =db.bib= and, for any translation entry (non-empty ~translation~ field) lacking an ~abstract~, translate the original entry's abstract and set it as the ~abstract~ of the translation entry. If the original has no abstract, a message is logged and the entry is skipped.
  - (II) External works: across the =fluid= and =stable= bibliographies (and =db.bib= originals), if a cited work does not have a DB translation entry, create missing abstract translations in =abstract-translations.json=. For each selected target language, if a translated abstract already exists in the JSON store, it is not re-created.

#+findex: tlon-translate-list-non-english-with-empty-translation
+ ~tlon-translate-list-non-english-with-empty-translation~ :: List all entries in =fluid.bib= and =stable.bib= whose ~langid~ is not =english= and whose ~translation~ field is empty. Displays the results in a dedicated buffer.

*** Revision
:PROPERTIES:
:CUSTOM_ID: h:tlon-translate-revision
:END:

#+findex: tlon-translate-revise-errors
+ ~tlon-translate-revise-errors~ :: Use an AI agent to spot errors in a translation. The agent is instructed to compare the translation with the original and correct any errors found, such as missing content, corrupted code, or inconsistent use of abbreviations.

#+findex: tlon-translate-revise-flow
+ ~tlon-translate-revise-flow~ :: Use an AI agent to improve the flow of a translation. The agent is instructed to make the translation less literal, while respecting the terminology in the relevant glossary.

#+findex: tlon-translate-revise-errors-in-range
+ ~tlon-translate-revise-errors-in-range~ :: Spot errors but only within a user-specified inclusive paragraph range.

#+findex: tlon-translate-improve-errors-in-range
+ ~tlon-translate-improve-errors-in-range~ :: Improve the flow only within a user-specified inclusive paragraph range.

#+findex: tlon-translate-revise-abort
+ ~tlon-translate-revise-abort~ :: Abort all ongoing revision requests, immediately stopping any remaining AI jobs.

*** Transient Menu
:PROPERTIES:
:CUSTOM_ID: h:tlon-translate-menu
:END:
#+findex: tlon-translate-menu
The command ~tlon-translate-menu~ activates a =transient= menu for file translation operations.

It provides the following groups and commands:
+ *Translate*:
  + =f= :: Translate file (~tlon-translate-file~)
+ *Revise*:
  + =e= :: Spot errors (~tlon-translate-revise-errors~)
  + =f= :: Improve flow (~tlon-translate-revise-flow~)
  + =E= :: Spot errors in range (~tlon-translate-revise-errors-in-range~)
  + =F= :: Improve flow in range (~tlon-translate-improve-errors-in-range~)
+ *Options*:
  + =c= :: Commit changes after revision (~tlon-translate-infix-toggle-commit-changes~)
  + =n= :: Paragraph chunk size (~tlon-translate-infix-set-chunk-size~)
  + =e= :: Select Engine (~tlon-translation-engine-infix~) - Select the translation engine (e.g., 'deepl).
  + =m -e= :: Revise errors model (~tlon-translate-infix-select-revise-errors-model~)
  + =m -f= :: Revise flow model (~tlon-translate-infix-select-revise-flow-model~)

** Internal Functions
:PROPERTIES:
:CUSTOM_ID: h:tlon-translate-internals
:END:

#+findex: tlon-translate--do-translate
+ ~tlon-translate--do-translate~ :: Handles the actual translation process. It reads the source file, calls the selected translation engine's function, writes the result to the target file, and opens it.
#+findex: tlon-translate--external-abstracts
+ ~tlon-translate--external-abstracts~ :: Implements case (II): finds and translates missing abstracts for non-DB works into the JSON store.
#+findex: tlon-translate--internal-abstracts
+ ~tlon-translate--internal-abstracts~ :: Implements case (I): scans =db.bib= for translation entries missing an ~abstract~, translates from the original entry's abstract, and writes the result into =db.bib=.
#+findex: tlon-translate--db-set-abstract
+ ~tlon-translate--db-set-abstract~ :: Helper to write/update the ~abstract~ field of a DB entry directly in =db.bib=.

#+findex: tlon-translate--get-translation-from-original
+ ~tlon-translate--get-translation-from-original~ :: A helper that, given an original file, finds its translation for a specific =LANG-CODE=. It checks metadata and falls back to constructing a path in a counterpart directory if no metadata entry is found.

#+findex: tlon-translate--get-deepl-translation-from-buffer
+ ~tlon-translate--get-deepl-translation-from-buffer~ :: A callback function used with ~tlon-deepl-translate~ to parse the JSON response from the DeepL API and extract the translated text string.

#+findex: tlon-translate--revise-common
+ ~tlon-translate--revise-common~ :: A helper function that handles the common logic for both revision commands. It prompts for the translation file, finds its original, prepares the prompt and tools, and makes the AI request.

#+findex: tlon-translate--revise-callback
+ ~tlon-translate--revise-callback~ :: The callback function for the revision commands. After the AI agent finishes, it commits the changes to the file with an appropriate message.

#+findex: tlon-translation-engine-infix
+ ~tlon-translation-engine-infix~ :: The transient infix command for selecting the translation engine via ~tlon-translation-engine~.

#+findex: tlon-translate-infix-select-revise-errors-model
+ ~tlon-translate-infix-select-revise-errors-model~ :: The transient infix command for selecting the AI model for spotting errors.

#+findex: tlon-translate-infix-select-revise-flow-model
+ ~tlon-translate-infix-select-revise-flow-model~ :: The transient infix command for selecting the AI model for improving flow.

#+findex: tlon-translate-infix-toggle-commit-changes
+ ~tlon-translate-infix-toggle-commit-changes~ :: The transient infix command for toggling whether to commit changes after an AI revision.
