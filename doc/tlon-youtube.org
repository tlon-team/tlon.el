#+title: tlon - YouTube Functionality
#+author: Pablo Stafforini
#+EXCLUDE_TAGS: noexport
#+language: en
#+options: ':t toc:nil author:t email:t num:t
#+startup: content
#+texinfo_header: @set MAINTAINERSITE @uref{https://github.com/tlon-team/tlon,maintainer webpage}
#+texinfo_header: @set MAINTAINER Pablo Stafforini
#+texinfo_header: @set MAINTAINEREMAIL @email{pablo@tlon.team}
#+texinfo_header: @set MAINTAINERCONTACT @uref{mailto:pablo@tlon.team,contact the maintainer}
#+texinfo: @insertcopying

* YouTube Functionality (=tlon-youtube.el=)
:PROPERTIES:
:CUSTOM_ID: h:tlon-youtube
:END:

This module provides functionality to process and upload podcast episodes to YouTube.

** Menu
:PROPERTIES:
:CUSTOM_ID: h:tlon-youtube-menu
:END:

#+findex: tlon-youtube-menu
+ ~tlon-youtube-menu~ :: Opens the main transient menu for YouTube-related operations. This menu allows access to commands and options for video generation and YouTube integration.

** User Options
:PROPERTIES:
:CUSTOM_ID: h:tlon-youtube-options
:END:

#+vindex: tlon-youtube-video-resolution
+ ~tlon-youtube-video-resolution~ :: A cons cell `(WIDTH . HEIGHT)` specifying the video resolution for generated videos. Defaults to 720p `(1280 . 720)`. Common resolutions include:
  - 720p:  `(1280 . 720)`
  - 1080p: `(1920 . 1080)`
  - 1440p: `(2560 . 1440)`
  - 4K (2160p): `(3840 . 2160)`
  This option can be configured via the [[h:tlon-youtube-menu][tlon-youtube-menu]].

#+vindex: tlon-youtube-api-key
+ ~tlon-youtube-api-key~ :: YouTube Data API v3 key for API requests. This should be obtained from the Google Cloud Console. Currently used for read-only operations.

#+vindex: tlon-youtube-client-id
+ ~tlon-youtube-client-id~ :: OAuth 2.0 client ID for YouTube API authentication. This should be obtained from the Google Cloud Console and is required for uploading videos and thumbnails.

#+vindex: tlon-youtube-client-secret
+ ~tlon-youtube-client-secret~ :: OAuth 2.0 client secret for YouTube API authentication. This should be obtained from the Google Cloud Console and is required for uploading videos and thumbnails.

#+vindex: tlon-youtube-default-privacy
+ ~tlon-youtube-default-privacy~ :: Default privacy setting for uploaded videos. Valid values are "private", "unlisted", or "public". Defaults to "private".

** Video Generation
:PROPERTIES:
:CUSTOM_ID: h:tlon-youtube-video-generation
:END:

#+findex: tlon-youtube-generate-wavelength-video
+ ~tlon-youtube-generate-wavelength-video~ :: Generates a video with an animated wavelength from an audio file using ~seewav~. The resolution of the video is determined by the ~tlon-youtube-video-resolution~ user option. Prompts the user to select an audio file from the "uqbar-audio" repository. The output video is saved in the ~paths-dir-downloads~ directory with a ~.mp4~ extension, using the original audio file name. This command can also be accessed via the [[h:tlon-youtube-menu][tlon-youtube-menu]].

#+findex: tlon-youtube-generate-thumbnail
+ ~tlon-youtube-generate-thumbnail~ :: Generates a thumbnail image for a video.
  The dimensions of the thumbnail are determined by the ~tlon-youtube-video-resolution~ user option.
  It prompts the user for a video title and author(s).
  The Tlön logo (from the "tlon.team-content" repository, specifically ~images/ea-logo-transparent.png~) is automatically trimmed, resized, and added to the thumbnail.
  The output image is saved as ~thumbnail.png~ in the ~paths-dir-downloads~ directory.
  This command can also be accessed via the [[h:tlon-youtube-menu][tlon-youtube-menu]].

** YouTube API Integration
:PROPERTIES:
:CUSTOM_ID: h:tlon-youtube-api
:END:

#+findex: tlon-youtube-upload-video
+ ~tlon-youtube-upload-video~ :: Uploads a video file to YouTube using the YouTube Data API v3. This command uses the ~curl~ command-line tool to perform the upload. Prompts the user to select a video file (filtered to show only ~.mp4~ files), enter a title and description, and choose a privacy setting ("private", "unlisted", or "public"). Requires ~tlon-youtube-client-id~ and ~tlon-youtube-client-secret~ to be configured, as well as a valid OAuth 2.0 access token (set via the ~YOUTUBE_ACCESS_TOKEN~ environment variable). This command can also be accessed via the [[h:tlon-youtube-menu][tlon-youtube-menu]].

#+findex: tlon-youtube-upload-thumbnail
+ ~tlon-youtube-upload-thumbnail~ :: Uploads a thumbnail image to an existing YouTube video. Prompts the user to select a thumbnail file (filtered to show ~.png~, ~.jpg~, and ~.jpeg~ files) and enter the YouTube video ID. Requires the same authentication setup as ~tlon-youtube-upload-video~. This command can also be accessed via the [[h:tlon-youtube-menu][tlon-youtube-menu]].

#+findex: tlon-youtube-authorize
+ ~tlon-youtube-authorize~ :: Starts the OAuth 2.0 authorization flow for the YouTube API. This opens a browser window for you to authorize the application and automatically obtains both access and refresh tokens. You only need to run this once - the refresh token will be used to automatically get new access tokens when they expire. This command can also be accessed via the [[h:tlon-youtube-menu][tlon-youtube-menu]].

*** Authentication Setup
:PROPERTIES:
:CUSTOM_ID: h:tlon-youtube-auth
:END:

To fix the `redirect_uri_mismatch` error, you must create a new OAuth Client ID in the Google Cloud Console with the correct settings. Please follow these steps carefully:

1. Go to the [[https://console.cloud.google.com/apis/credentials][Credentials page]] in the Google Cloud Console.
2. Select the project you are using for Tlön.
3. Click *+ CREATE CREDENTIALS* at the top and select *OAuth client ID*.
4. For *Application type*, select **Web application**.
5. Give it a name, for example, "Tlön Emacs Client (Web)".
6. Under *Authorized redirect URIs*, click *+ ADD URI*.
7. In the text box that appears, enter **exactly** this value: `http://localhost:8080`
8. Click *CREATE*.
9. A dialog will show your new "Client ID" and "Client Secret". Copy these new credentials.
10. Update your Emacs configuration (`tlon-youtube-client-id` and `tlon-youtube-client-secret`) with these **new** values. It is highly recommended to use `auth-source` or another secrets management tool.

After you have created the new credentials and updated your Emacs configuration, you can proceed with authorization.

**** Getting Authorization
:PROPERTIES:
:CUSTOM_ID: h:tlon-youtube-authorization
:END:

Once your new credentials are set up, you need to authorize the application.

**Workflow:**
1. Run ~M-x tlon-youtube-authorize~.
2. This will open your browser to Google's authorization page.
3. Sign in with your Google account and authorize the application.
4. After you approve, Google will redirect your browser to `http://localhost:8080/?code=...`. The page may show a "This site can’t be reached" error. This is expected and normal.
5. Copy the entire URL from your browser's address bar.
6. From the URL, you need to extract the authorization code. It's the long string of characters that comes after `code=` and before `&scope`.
   - Example URL: `http://localhost:8080/?code=4/0A...qg&scope=https://...`
   - In this example, the code is `4/0A...qg`.
7. Paste *only the authorization code* into the Emacs prompt.
8. The system will exchange the code for an access token and a refresh token.

**That's it!** The system will automatically use the refresh token to get new access tokens when they expire (typically every hour), so you should only need to authorize once.

**When you get a 401 error:** The system will automatically attempt to refresh your access token. If that fails (e.g., if the refresh token is revoked), you may need to re-authorize by running ~M-x tlon-youtube-authorize~ again.
